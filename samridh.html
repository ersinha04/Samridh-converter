<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samridh AI - Your Advanced Assistant</title>
    
    <!-- Tailwind CSS for rapid styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Base styling */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: #0a192f;
        }

        /* Animated Background */
        @keyframes move-twink-back {
            from {background-position:0 0;}
            to {background-position:-10000px 5000px;}
        }
        .stars, .twinkling {
            position:absolute;
            top:0;
            left:0;
            right:0;
            bottom:0;
            width:100%;
            height:100%;
            display:block;
            z-index: -1;
        }
        .stars {
            background:#000 url(https://www.script-tutorials.com/demos/360/images/stars.png) repeat top center;
        }
        .twinkling {
            background:transparent url(https://www.script-tutorials.com/demos/360/images/twinkling.png) repeat top center;
            animation:move-twink-back 200s linear infinite;
        }


        /* Glassmorphism effect for the chat container and modals */
        .glass-effect {
            background: rgba(10, 25, 47, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom scrollbar */
        #chat-content::-webkit-scrollbar { width: 6px; }
        #chat-content::-webkit-scrollbar-track { background: transparent; }
        #chat-content::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        
        /* Typing indicator animation */
        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #999;
            margin: 0 2px;
            animation: wave 1.3s linear infinite;
        }
        .dot:nth-child(2) { animation-delay: -1.1s; }
        .dot:nth-child(3) { animation-delay: -0.9s; }

        @keyframes wave {
            0%, 60%, 100% { transform: initial; }
            30% { transform: translateY(-10px); }
        }
        
        /* Message entrance animation */
        .message-container {
            animation: slideInUp 0.5s ease-out forwards;
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Markdown formatting */
        .bot-message code { background-color: #161B22; padding: 2px 6px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; }
        .bot-message pre { background-color: #0d1117; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 10px 0; border: 1px solid #30363d; }
        .bot-message pre code { padding: 0; background: none; border: none; }
        
        /* Input glow effect */
        #user-input:focus {
            box-shadow: 0 0 15px rgba(192, 132, 252, 0.5);
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="flex justify-center items-center h-screen p-4">
    
    <!-- Animated Background -->
    <div class="stars"></div>
    <div class="twinkling"></div>

    <!-- DESKTOP OPTIMIZATION: max-w-2xl changed to responsive widths -->
    <div id="chat-container" class="w-full max-w-2xl lg:max-w-4xl xl:max-w-5xl h-[90vh] md:h-[85vh] rounded-2xl shadow-2xl flex flex-col transition-all duration-500 glass-effect">
        
        <!-- Chat Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-700 flex-shrink-0">
            <div class="flex items-center space-x-3">
                <img src="http://googleusercontent.com/file_content/28" alt="Logo" class="w-10 h-10 rounded-full">
                <div>
                    <h1 class="text-lg font-bold text-white">Samridh AI</h1>
                    <p class="text-xs text-green-400">Online</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="summarize-btn" title="✨ Summarize Chat" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-book-open"></i>
                </button>
                <button id="clear-chat-btn" title="Clear Chat" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button id="export-chat-btn" title="Export Chat" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>

        <!-- Chat Content -->
        <div id="chat-content" class="flex-grow p-4 overflow-y-auto space-y-4">
            <!-- Messages will be appended here -->
        </div>

        <!-- Suggested Prompts -->
        <div id="suggested-prompts" class="p-4 border-t border-gray-700 flex-shrink-0">
            <div class="flex flex-wrap gap-2 justify-center"></div>
        </div>

        <!-- Image Preview -->
        <div id="image-preview-container" class="hidden p-2 border-t border-gray-700 flex-shrink-0">
            <div class="relative w-20 h-20">
                <img id="image-preview" class="w-full h-full object-cover rounded-md" src="">
                <button id="remove-image-btn" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs flex items-center justify-center">&times;</button>
            </div>
        </div>

        <!-- Chat Input Form -->
        <div class="p-4 border-t border-gray-700 flex-shrink-0">
            <form id="chat-form" class="flex items-center space-x-2">
                <label for="image-upload" class="cursor-pointer text-gray-400 hover:text-white p-2 rounded-full transition">
                    <i class="fas fa-paperclip"></i>
                </label>
                <input type="file" id="image-upload" class="hidden" accept="image/*">
                
                <input type="text" id="user-input" class="flex-grow bg-gray-800 text-white placeholder-gray-500 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 transition" placeholder="Ask anything, or try /imagine..." required>
                
                <button id="mic-btn" type="button" class="text-gray-400 hover:text-white p-2 rounded-full transition">
                    <i class="fas fa-microphone"></i>
                </button>
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white rounded-full w-12 h-10 flex items-center justify-center font-semibold transition">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Summary Modal -->
    <!-- DESKTOP OPTIMIZATION: max-w-lg changed to md:max-w-2xl -->
    <div id="summary-modal" class="modal-overlay">
        <div class="modal-content glass-effect rounded-2xl w-full max-w-lg md:max-w-2xl p-6 text-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">✨ Conversation Summary</h2>
                <button id="close-summary-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="summary-text" class="text-left max-h-96 overflow-y-auto text-gray-300"></div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="modal-overlay">
        <div class="flex flex-col items-center justify-center text-white">
            <i class="fas fa-spinner fa-spin text-4xl"></i>
            <p id="loading-text" class="mt-4 text-lg">Processing...</p>
        </div>
    </div>

    <script>
        // DOM Elements
        const chatContent = document.getElementById("chat-content");
        const chatForm = document.getElementById("chat-form");
        const userInput = document.getElementById("user-input");
        const micBtn = document.getElementById("mic-btn");
        const exportChatBtn = document.getElementById("export-chat-btn");
        const clearChatBtn = document.getElementById("clear-chat-btn");
        const summarizeBtn = document.getElementById("summarize-btn");
        const suggestedPromptsContainer = document.getElementById("suggested-prompts");
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const summaryModal = document.getElementById('summary-modal');
        const closeSummaryBtn = document.getElementById('close-summary-btn');
        const summaryText = document.getElementById('summary-text');
        const loadingModal = document.getElementById('loading-modal');
        const loadingText = document.getElementById('loading-text');

        let chatHistory = [];
        let base64ImageData = null;
        let audioContext;
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.error("Web Audio API is not supported in this browser.");
        }

        // --- Core Functions ---

        const renderMessage = (text, sender, imageUrl = null) => {
            const messageId = `msg-${Date.now()}`;
            const isBot = sender === 'bot';
            const avatar = isBot
                ? `<img src="http://googleusercontent.com/file_content/28" alt="Logo" class="w-8 h-8 rounded-full flex-shrink-0">`
                : `<div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center font-bold text-white text-sm flex-shrink-0">You</div>`;
            
            const messageContainer = document.createElement("div");
            messageContainer.className = `message-container flex items-start gap-3 ${isBot ? '' : 'flex-row-reverse'}`;
            
            const formattedText = isBot ? formatBotResponse(text) : text;

            messageContainer.innerHTML = `
                ${avatar}
                <div id="${messageId}" class="max-w-md lg:max-w-lg p-3 rounded-xl ${isBot ? 'bg-gray-700 text-gray-200' : 'bg-purple-600 text-white'}">
                    ${imageUrl ? `<img src="${imageUrl}" class="w-full rounded-lg mb-2 max-w-xs">` : ''}
                    <p class="whitespace-pre-wrap">${formattedText}</p>
                    ${isBot ? `
                        <div class="flex items-center justify-end gap-3 mt-2 text-xs text-gray-400">
                            <button onclick="copyToClipboard('${messageId}')" title="Copy"><i class="fas fa-copy hover:text-white"></i></button>
                            <button onclick="playAudioResponse(this, '${messageId}')" title="Read aloud"><i class="fas fa-volume-up hover:text-white"></i></button>
                        </div>
                    ` : ''}
                </div>
            `;
            chatContent.appendChild(messageContainer);
            scrollToBottom();
        };

        const formatBotResponse = (text) => {
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                       .replace(/\*(.*?)\*/g, '<em>$1</em>')
                       .replace(/```([\s\S]*?)```/g, (match, code) => `<pre><code>${code.trim().replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>`)
                       .replace(/`(.*?)`/g, '<code>$1</code>');
        };

        const showTypingIndicator = () => {
            const indicator = document.createElement("div");
            indicator.id = "typing-indicator";
            indicator.className = "message-container flex items-center gap-3";
            indicator.innerHTML = `
                <img src="http://googleusercontent.com/file_content/28" alt="Logo" class="w-8 h-8 rounded-full flex-shrink-0">
                <div class="p-3 rounded-xl bg-gray-700">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
            `;
            chatContent.appendChild(indicator);
            scrollToBottom();
        };

        const removeTypingIndicator = () => {
            document.getElementById("typing-indicator")?.remove();
        };
        
        const showLoading = (text = "Processing...") => {
            loadingText.innerText = text;
            loadingModal.classList.add('active');
        };
        
        const hideLoading = () => {
            loadingModal.classList.remove('active');
        };

        // --- API & State Management ---
        const getBotResponse = async (userMessage, imageData = null) => {
            showTypingIndicator();
            try {
                const parts = [{ text: userMessage }];
                if (imageData) parts.push({ inlineData: { mimeType: "image/png", data: imageData } });
                
                const payload = { contents: [{ role: "user", parts }] };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't process that.";
                
                chatHistory.push({ sender: 'bot', text });
                saveChatHistory();
                removeTypingIndicator();
                renderMessage(text, 'bot');
            } catch (error) {
                console.error("Error fetching bot response:", error);
                removeTypingIndicator();
                renderMessage("Oops! Something went wrong. Please try again.", 'bot');
            }
        };

        const saveChatHistory = () => localStorage.setItem('samridhAIChatHistory', JSON.stringify(chatHistory));
        const loadChatHistory = () => {
            const savedHistory = localStorage.getItem('samridhAIChatHistory');
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
                chatHistory.forEach(msg => renderMessage(msg.text, msg.sender, msg.imageUrl));
            } else {
                const welcomeText = "Hello! I'm Samridh AI. I remember our conversations, including the one about your roof's memory (छत की मेमोरी). How can I help you today?";
                renderMessage(welcomeText, 'bot');
                chatHistory.push({ sender: 'bot', text: welcomeText });
                saveChatHistory();
            }
        };

        // --- Event Handlers & Utilities ---
        chatForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const userMessage = userInput.value.trim();
            if (!userMessage && !base64ImageData) return;

            if (userMessage.toLowerCase().startsWith('/imagine ')) {
                const prompt = userMessage.substring(8).trim();
                if (prompt) {
                    renderMessage(userMessage, 'user');
                    chatHistory.push({ sender: 'user', text: userMessage });
                    saveChatHistory();
                    userInput.value = "";
                    await generateImage(prompt);
                }
                return;
            }

            const userImageUrl = base64ImageData ? `data:image/png;base64,${base64ImageData}` : null;
            renderMessage(userMessage, 'user', userImageUrl);
            chatHistory.push({ sender: 'user', text: userMessage, imageUrl: userImageUrl });
            saveChatHistory();
            
            getBotResponse(userMessage, base64ImageData);

            userInput.value = "";
            resetImageUpload();
            suggestedPromptsContainer.classList.add('hidden');
        });

        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => {
                base64ImageData = reader.result.split(',')[1];
                imagePreview.src = reader.result;
                imagePreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        const resetImageUpload = () => {
            base64ImageData = null;
            imageUpload.value = '';
            imagePreviewContainer.classList.add('hidden');
        };
        removeImageBtn.addEventListener('click', resetImageUpload);

        const scrollToBottom = () => chatContent.scrollTop = chatContent.scrollHeight;
        window.copyToClipboard = (elementId) => navigator.clipboard.writeText(document.getElementById(elementId).innerText);

        // --- Gemini API Features ---

        const generateImage = async (prompt) => {
            showLoading("✨ Generating your image...");
            try {
                const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1 } };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Image API error: ${response.statusText}`);
                
                const result = await response.json();
                if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    renderMessage(`Here is your image for: "${prompt}"`, 'bot', imageUrl);
                    chatHistory.push({ sender: 'bot', text: `Image for: "${prompt}"`, imageUrl: imageUrl });
                    saveChatHistory();
                } else { throw new Error("Invalid image data received."); }

            } catch (error) {
                console.error("Error generating image:", error);
                renderMessage("Sorry, I couldn't create that image. Please try another prompt.", 'bot');
            } finally {
                hideLoading();
            }
        };

        summarizeBtn.addEventListener('click', async () => {
            if (chatHistory.length < 3) {
                alert("Not enough conversation to summarize!");
                return;
            }
            showLoading("✨ Summarizing conversation...");
            try {
                const conversationText = chatHistory.map(msg => `${msg.sender}: ${msg.text}`).join('\n');
                const prompt = `Please provide a concise summary of the following conversation:\n\n${conversationText}`;
                
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error("Summary API error");

                const result = await response.json();
                const summary = result.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate summary.";
                
                summaryText.innerText = summary;
                summaryModal.classList.add('active');

            } catch (error) {
                console.error("Error summarizing chat:", error);
                alert("Failed to generate summary.");
            } finally {
                hideLoading();
            }
        });
        
        closeSummaryBtn.addEventListener('click', () => summaryModal.classList.remove('active'));


        // --- Advanced TTS using Gemini API ---
        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const pcmToWav = (pcmData, sampleRate) => {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            view.setUint32(0, 0x52494646, false);
            view.setUint32(4, 36 + dataSize, true);
            view.setUint32(8, 0x57415645, false);
            view.setUint32(12, 0x666d7420, false);
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true);
            view.setUint32(36, 0x64617461, false);
            view.setUint32(40, dataSize, true);

            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        };

        window.playAudioResponse = async (button, elementId) => {
            if (!audioContext) {
                alert("Sorry, your browser doesn't support audio playback.");
                return;
            }
            const textToSpeak = document.getElementById(elementId).innerText;
            const icon = button.querySelector('i');
            icon.classList.remove('fa-volume-up');
            icon.classList.add('fa-spinner', 'fa-spin');

            try {
                const payload = {
                    contents: [{ parts: [{ text: `TTS the following in a clear, natural Hindi voice: ${textToSpeak}` }] }],
                    generationConfig: { responseModalities: ["AUDIO"] },
                    model: "gemini-2.5-flash-preview-tts"
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error("TTS API Error");
                
                const result = await response.json();
                const audioData = result.candidates[0].content.parts[0].inlineData.data;
                const sampleRate = 24000;

                const pcmBuffer = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmBuffer);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                const audio = new Audio(audioUrl);
                audio.play();
                audio.onended = () => URL.revokeObjectURL(audioUrl);

            } catch (error) {
                console.error("Error playing TTS audio:", error);
                alert("Could not play the audio.");
            } finally {
                icon.classList.remove('fa-spinner', 'fa-spin');
                icon.classList.add('fa-volume-up');
            }
        };


        // Speech Recognition
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'hi-IN';
        recognition.interimResults = false;
        micBtn.addEventListener('click', () => { micBtn.classList.add('text-red-500'); recognition.start(); });
        recognition.onresult = (event) => { userInput.value = event.results[0][0].transcript; };
        recognition.onend = () => { micBtn.classList.remove('text-red-500'); };

        // Export & Clear Chat
        exportChatBtn.addEventListener('click', () => {
            const chatText = chatHistory.map(msg => `${msg.sender.toUpperCase()}: ${msg.text}`).join('\n\n');
            const blob = new Blob([chatText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'samridh-ai-chat.txt';
            a.click();
            URL.revokeObjectURL(url);
        });
        
        clearChatBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to clear the chat history?")) {
                chatHistory = [];
                localStorage.removeItem('samridhAIChatHistory');
                chatContent.innerHTML = '';
                const welcomeText = "Chat cleared! How can I help you start a new conversation?";
                renderMessage(welcomeText, 'bot');
                chatHistory.push({ sender: 'bot', text: welcomeText });
                saveChatHistory();
                renderPrompts();
            }
        });
        
        // Suggested Prompts
        const prompts = ["झारखंड के बारे में एक कविता लिखो", "Quantum computing क्या है?", "Try: /imagine a robot reading a book", "बटर चिकन की रेसिपी बताओ"];
        const renderPrompts = () => {
            if (chatHistory.length > 1) {
                suggestedPromptsContainer.classList.add('hidden');
                return;
            }
            suggestedPromptsContainer.classList.remove('hidden');
            suggestedPromptsContainer.innerHTML = prompts.map(p => 
                `<button class="bg-gray-700 text-gray-200 text-sm px-3 py-1 rounded-full hover:bg-gray-600 transition">${p}</button>`
            ).join('');
            
            suggestedPromptsContainer.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    userInput.value = btn.innerText;
                    chatForm.requestSubmit();
                });
            });
        };

        // --- Initialization ---
        loadChatHistory();
        renderPrompts();

    </script>
</body>
</html>
