import React, { useRef, useState, useEffect } from 'react';

// Samridh Image Resizer - Single-file React component
// TailwindCSS utility classes are used for styling (no external CSS here)
// Features: drag & drop upload, preview, automatic 1200x720 default frame,
// manual width/height, lock aspect ratio, format select, quality slider, download.

export default function SamridhImageResizer() {
  const DEFAULT_W = 1200;
  const DEFAULT_H = 720;

  const fileInputRef = useRef(null);
  const canvasRef = useRef(null);
  const [file, setFile] = useState(null);
  const [image, setImage] = useState(null);
  const [width, setWidth] = useState(DEFAULT_W);
  const [height, setHeight] = useState(DEFAULT_H);
  const [keepAspect, setKeepAspect] = useState(true);
  const [format, setFormat] = useState('image/jpeg');
  const [quality, setQuality] = useState(0.9);
  const [dragging, setDragging] = useState(false);
  const [message, setMessage] = useState('Drop an image or click Upload');

  useEffect(() => {
    if (!file) return;
    const img = new Image();
    img.onload = () => setImage(img);
    img.onerror = () => setMessage('Failed to load image');
    img.src = URL.createObjectURL(file);
    return () => URL.revokeObjectURL(img.src);
  }, [file]);

  // Keep aspect when user changes width/height
  useEffect(() => {
    if (!image || !keepAspect) return;
    const ratio = image.width / image.height;
    // If width changed recently, derive height; if height changed, derive width.
    // We'll naively prefer width as controlling if both equal default.
    setHeight(Math.round(width / ratio));
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [width]);

  useEffect(() => {
    if (!image || !keepAspect) return;
    const ratio = image.width / image.height;
    setWidth(Math.round(height * ratio));
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [height]);

  useEffect(() => {
    drawPreview();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [image, width, height, format, quality]);

  function onFiles(selectedFiles) {
    if (!selectedFiles || selectedFiles.length === 0) return;
    const f = selectedFiles[0];
    if (!f.type.startsWith('image/')) {
      setMessage('Please upload an image file (png, jpeg, webp, etc.)');
      return;
    }
    setFile(f);
    setMessage('Image loaded — edit settings and click Download');
  }

  function handleDrop(e) {
    e.preventDefault();
    setDragging(false);
    const dt = e.dataTransfer;
    onFiles(dt.files);
  }

  function handleDragOver(e) {
    e.preventDefault();
    setDragging(true);
  }

  function handleDragLeave(e) {
    e.preventDefault();
    setDragging(false);
  }

  function drawPreview() {
    const canvas = canvasRef.current;
    if (!canvas || !image) return;
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    // Clear
    ctx.fillStyle = '#111827';
    ctx.fillRect(0, 0, width, height);
    // Compute fit-cover style: center-crop
    const imgRatio = image.width / image.height;
    const canvasRatio = width / height;
    let drawW = width, drawH = height, sx = 0, sy = 0;
    if (imgRatio > canvasRatio) {
      // image is wider; crop sides
      drawH = height;
      drawW = Math.round(height * imgRatio);
      sx = Math.round((image.width - image.height * canvasRatio) / 2);
      ctx.drawImage(image, sx, 0, image.width - sx * 2, image.height, 0, 0, width, height);
    } else {
      // image is taller; crop top/bottom
      drawW = width;
      drawH = Math.round(width / imgRatio);
      sy = Math.round((image.height - image.width / canvasRatio) / 2);
      ctx.drawImage(image, 0, sy, image.width, image.height - sy * 2, 0, 0, width, height);
    }
    // draw subtle frame
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = Math.max(1, Math.min(width, height) * 0.002);
    ctx.strokeRect(0.5, 0.5, width - 1, height - 1);
  }

  function download() {
    if (!canvasRef.current) return;
    const canvas = canvasRef.current;
    canvas.toBlob(
      (blob) => {
        if (!blob) {
          setMessage('Failed to generate file');
          return;
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const ext = format === 'image/png' ? 'png' : format === 'image/webp' ? 'webp' : 'jpg';
        a.download = `samridh-resize-${width}x${height}.${ext}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setMessage('Download started');
      },
      format,
      quality
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900 text-slate-100 p-6 flex flex-col items-center">
      <header className="w-full max-w-5xl mb-6">
        <div className="flex items-center justify-between">
          <h1 className="text-3xl font-extrabold tracking-tight">Samridh Media — Image Resizer</h1>
          <div className="text-sm opacity-80">Developed by ER • Auto frame: 1200×720</div>
        </div>
      </header>

      <main className="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left: uploader & controls */}
        <section className="lg:col-span-1 p-4 rounded-2xl bg-slate-800/60 backdrop-blur-sm border border-slate-700">
          <div
            onDrop={handleDrop}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            className={`w-full p-4 rounded-lg border-2 ${dragging ? 'border-dashed border-cyan-400' : 'border-dashed border-slate-600'} cursor-pointer`}
            onClick={() => fileInputRef.current?.click()}
          >
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*"
              className="hidden"
              onChange={(e) => onFiles(e.target.files)}
            />
            <div className="flex flex-col items-center justify-center gap-3 py-6">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 16v-4a4 4 0 118 0v4m-5 4h6" />
              </svg>
              <div className="text-sm text-slate-300">{message}</div>
              <div className="text-xs text-slate-400 mt-1">Click or drop — supported: PNG, JPEG, WebP</div>
            </div>
          </div>

          <div className="mt-4 space-y-3">
            <label className="block text-xs uppercase tracking-wide text-slate-400">Dimensions</label>
            <div className="flex gap-2">
              <input type="number" value={width} onChange={(e) => setWidth(Number(e.target.value) || 1)} className="w-1/2 p-2 rounded-md bg-slate-700 text-slate-100" />
              <input type="number" value={height} onChange={(e) => setHeight(Number(e.target.value) || 1)} className="w-1/2 p-2 rounded-md bg-slate-700 text-slate-100" />
            </div>
            <div className="flex items-center gap-2 text-sm">
              <input id="aspect" type="checkbox" checked={keepAspect} onChange={(e) => setKeepAspect(e.target.checked)} />
              <label htmlFor="aspect" className="text-slate-300">Keep aspect ratio</label>
            </div>

            <label className="block text-xs uppercase tracking-wide text-slate-400 mt-2">Format & Quality</label>
            <div className="flex gap-2 items-center">
              <select value={format} onChange={(e) => setFormat(e.target.value)} className="p-2 rounded-md bg-slate-700 text-slate-100">
                <option value="image/jpeg">JPEG</option>
                <option value="image/png">PNG</option>
                <option value="image/webp">WebP</option>
              </select>
              <div className="flex-1">
                <input type="range" min="0.1" max="1" step="0.01" value={quality} onChange={(e) => setQuality(Number(e.target.value))} />
                <div className="text-xs text-slate-400">Quality: {Math.round(quality * 100)}%</div>
              </div>
            </div>

            <div className="mt-4 flex gap-2">
              <button onClick={() => { setWidth(DEFAULT_W); setHeight(DEFAULT_H); }} className="flex-1 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-slate-900 font-semibold">Reset to 1200×720</button>
              <button onClick={() => { setFile(null); setImage(null); setMessage('Drop an image or click Upload'); }} className="py-2 px-4 rounded-lg border border-slate-600">Clear</button>
            </div>

            <div className="mt-3">
              <button onClick={download} className="w-full py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold" disabled={!image}>Download</button>
            </div>
          </div>
        </section>

        {/* Center: preview */}
        <section className="lg:col-span-2 p-4 rounded-2xl bg-slate-800/60 border border-slate-700">
          <div className="flex flex-col lg:flex-row gap-4">
            <div className="flex-1 flex flex-col items-center gap-3">
              <div className="w-full bg-slate-900/60 rounded-lg p-4 flex flex-col items-center">
                <div className="text-sm text-slate-300 mb-2">Preview</div>
                <div className="w-full rounded-md overflow-hidden bg-black/60" style={{ maxWidth: '100%' }}>
                  <canvas ref={canvasRef} className="w-full max-h-[60vh] block" />
                </div>
                {!image && (
                  <div className="mt-4 text-slate-400 text-sm">No image loaded — preview will appear here</div>
                )}
              </div>

              {image && (
                <div className="w-full mt-2 p-3 rounded-md bg-slate-900/40 border border-slate-700 text-xs text-slate-300">
                  Original: {image.width} × {image.height} px • Selected: {width} × {height} px
                </div>
              )}
            </div>

            <aside className="w-full lg:w-80 p-3 rounded-lg bg-slate-900/40 border border-slate-700">
              <h3 className="text-sm font-semibold mb-2">Quick Actions</h3>
              <div className="flex flex-col gap-2">
                <button onClick={() => { setWidth(1920); setHeight(1080); }} className="py-2 rounded-md bg-slate-700">1920 × 1080</button>
                <button onClick={() => { setWidth(1280); setHeight(720); }} className="py-2 rounded-md bg-slate-700">1280 × 720</button>
                <button onClick={() => { setWidth(800); setHeight(800); setKeepAspect(false); }} className="py-2 rounded-md bg-slate-700">800 × 800 (square)</button>
                <label className="text-xs text-slate-400 mt-3">Rotate preview (visual only)</label>
                <div className="text-xs text-slate-500">Tip: use download to get final image in chosen dimensions.</div>
              </div>
            </aside>
          </div>

          <footer className="mt-4 text-xs text-slate-500">Samridh Media • © {new Date().getFullYear()} • Developed by ER</footer>
        </section>
      </main>

    </div>
  );
}

